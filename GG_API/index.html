<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Maps Demo - Standalone</title>
    <link rel="stylesheet" href="index.css">
</head>
<body>
    <header>
        <h1>🗺️ Google Maps Demo - Test Version</h1>
    </header>

    <!-- Cảnh báo API Key -->
    <div id="apiWarning" class="api-warning">
        ⚠️ <strong>Cảnh báo:</strong> Đang sử dụng API Key mẫu. Vui lòng thay bằng API Key của bạn!
        <button onclick="this.parentElement.style.display='none'">Đóng</button>
    </div>

    <div class="container">
        <div class="sidebar">
            <div class="control-group">
                <label>🔍 Tìm kiếm địa điểm</label>
                <input type="text" id="searchInput" placeholder="Nhập tên địa điểm...">
                <button onclick="searchPlace()">Tìm kiếm</button>
            </div>

            <div class="control-group">
                <label>📍 Thêm marker tùy chỉnh</label>
                <input type="text" id="markerName" placeholder="Tên địa điểm">
                <button onclick="addCustomMarker()">Thêm Marker (Click trên map)</button>
            </div>

            <div class="control-group">
                <button class="secondary" onclick="clearMarkers()">Xóa tất cả Markers</button>
                <button class="secondary" onclick="getCurrentLocation()">📍 Vị trí hiện tại</button>
            </div>

            <div class="info-box">
                <h3>📊 Thông tin</h3>
                <p><strong>Tọa độ:</strong> <span id="currentCoords">-</span></p>
                <p><strong>Zoom:</strong> <span id="currentZoom">-</span></p>
                <p><strong>Markers:</strong> <span id="markerCount">0</span></p>
            </div>

            <div class="control-group">
                <h3 style="margin-bottom: 10px;">📌 Danh sách Markers</h3>
                <ul class="marker-list" id="markerList"></ul>
            </div>
        </div>

        <div id="map"></div>
    </div>

    <script>
        let map;
        let markers = [];
        let infoWindow;
        let addMarkerMode = false;

        // Khởi tạo map
        function initMap() {
            // Ẩn cảnh báo khi map load thành công
            document.getElementById('apiWarning').style.display = 'none';

            // Tọa độ mặc định: TP.HCM
            const defaultLocation = { lat: 10.7769, lng: 106.7009 };

            map = new google.maps.Map(document.getElementById('map'), {
                center: defaultLocation,
                zoom: 13,
                mapTypeControl: true,
                streetViewControl: true,
                fullscreenControl: true
            });

            infoWindow = new google.maps.InfoWindow();

            // Lắng nghe sự kiện click trên map
            map.addListener('click', (e) => {
                if (addMarkerMode) {
                    const name = document.getElementById('markerName').value || 'Địa điểm mới';
                    addMarker(e.latLng, name);
                    addMarkerMode = false;
                    document.getElementById('markerName').value = '';
                }
            });

            // Lắng nghe sự kiện di chuyển map
            map.addListener('center_changed', updateMapInfo);
            map.addListener('zoom_changed', updateMapInfo);

            // Cập nhật thông tin ban đầu
            updateMapInfo();
        }

        // Thêm marker
        function addMarker(location, title) {
            const marker = new google.maps.Marker({
                position: location,
                map: map,
                title: title,
                animation: google.maps.Animation.DROP
            });

            // Thêm sự kiện click cho marker
            marker.addListener('click', () => {
                const lat = typeof location.lat === 'function' ? location.lat() : location.lat;
                const lng = typeof location.lng === 'function' ? location.lng() : location.lng;
                
                infoWindow.setContent(`
                    <div style="padding: 10px;">
                        <h3 style="margin: 0 0 10px 0; color: #1976d2;">${title}</h3>
                        <p style="margin: 5px 0;"><strong>Vĩ độ:</strong> ${lat.toFixed(6)}</p>
                        <p style="margin: 5px 0;"><strong>Kinh độ:</strong> ${lng.toFixed(6)}</p>
                        <button onclick="removeMarkerByTitle('${title}')" style="margin-top: 10px; padding: 8px 16px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer;">Xóa marker này</button>
                    </div>
                `);
                infoWindow.open(map, marker);
            });

            markers.push({ marker, title, location });
            updateMarkerList();
            updateMarkerCount();
        }

        // Xóa marker theo title
        function removeMarkerByTitle(title) {
            const index = markers.findIndex(m => m.title === title);
            if (index !== -1) {
                markers[index].marker.setMap(null);
                markers.splice(index, 1);
                updateMarkerList();
                updateMarkerCount();
                infoWindow.close();
            }
        }

        // Xóa tất cả markers
        function clearMarkers() {
            markers.forEach(m => m.marker.setMap(null));
            markers = [];
            updateMarkerList();
            updateMarkerCount();
        }

        // Tìm kiếm địa điểm
        function searchPlace() {
            const input = document.getElementById('searchInput').value.trim();
            if (!input) {
                alert('Vui lòng nhập tên địa điểm!');
                return;
            }

            if (!google?.maps?.places) {
                alert('Places API chưa sẵn sàng. Vui lòng kiểm tra API Key!');
                return;
            }

            const service = new google.maps.places.PlacesService(map);
            service.findPlaceFromQuery({
                query: input,
                fields: ['name', 'geometry']
            }, (results, status) => {
                if (status === google.maps.places.PlacesServiceStatus.OK && results?.[0]) {
                    const place = results[0];
                    map.setCenter(place.geometry.location);
                    map.setZoom(15);
                    addMarker(place.geometry.location, place.name);
                    document.getElementById('searchInput').value = '';
                } else {
                    alert('Không tìm thấy: ' + input);
                }
            });
        }

        // Thêm marker tùy chỉnh
        function addCustomMarker() {
            addMarkerMode = true;
            alert('Click vào bất kỳ đâu trên map để thêm marker!');
        }

        // Lấy vị trí hiện tại
        function getCurrentLocation() {
            if (!navigator.geolocation) {
                alert('Trình duyệt không hỗ trợ định vị!');
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const pos = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    map.setCenter(pos);
                    map.setZoom(15);
                    addMarker(pos, '📍 Vị trí của bạn');
                },
                () => alert('Không thể lấy vị trí. Vui lòng cho phép truy cập!')
            );
        }



        // Cập nhật thông tin map
        function updateMapInfo() {
            const center = map.getCenter();
            document.getElementById('currentCoords').textContent = 
                `${center.lat().toFixed(4)}, ${center.lng().toFixed(4)}`;
            document.getElementById('currentZoom').textContent = map.getZoom();
        }

        // Cập nhật số lượng markers
        function updateMarkerCount() {
            document.getElementById('markerCount').textContent = markers.length;
        }

        // Cập nhật danh sách markers
        function updateMarkerList() {
            const list = document.getElementById('markerList');
            list.innerHTML = '';
            markers.forEach((m) => {
                const lat = typeof m.location.lat === 'function' ? m.location.lat() : m.location.lat;
                const lng = typeof m.location.lng === 'function' ? m.location.lng() : m.location.lng;
                
                const li = document.createElement('li');
                li.className = 'marker-item';
                li.innerHTML = `<strong>${m.title}</strong><br>
                                <small>${lat.toFixed(4)}, ${lng.toFixed(4)}</small>`;
                li.onclick = () => {
                    map.setCenter(m.location);
                    map.setZoom(15);
                    google.maps.event.trigger(m.marker, 'click');
                };
                list.appendChild(li);
            });
        }

        // Event listener cho tìm kiếm
        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') searchPlace();
        });
    </script>

    <!-- 
        ⚠️ THAY YOUR_API_KEY_HERE BẰNG API KEY CỦA BẠN ⚠️
        Lấy API key tại: https://console.cloud.google.com/
    -->
       
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBrcMewnsYngjpYP2wyJWA2LCWStmpACnQ&callback=initMap&libraries=places" async defer></script>
</body>
</html>